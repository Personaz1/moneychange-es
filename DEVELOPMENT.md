# TorrExchange - Ход разработки

## Текущее состояние (08.04.2025)

### Фронтенд
- ✅ Базовый интерфейс обмена валют
- ✅ Мультиязычность (EN, ES, RU)
- ✅ Калькулятор обмена валют
- ✅ Таблица текущих курсов валют
- ✅ Адаптивный дизайн
- ✅ Интеграция флагов стран
- ✅ Загрузка изображений и ресурсов
- ✅ Отображение всех валют с корректной маржой

### Бэкенд (Strapi)
- ✅ Настроен базовый API для курсов валют
- ✅ Реализовано автоматическое обновление курсов
- ✅ Настроена SQLite база данных
- ✅ Реализован контроллер для работы с курсами валют
- ✅ Настроена периодическая синхронизация курсов
- ✅ Реализована поддержка всех валют через API
- ✅ Добавлена поддержка ручного переопределения курсов

### Инфраструктура
- ✅ Настроен dev-сервер на порту 8000 (фронтенд)
- ✅ Настроен Strapi на порту 1337 (бэкенд)
- ✅ Базовая структура проекта
- ✅ Настроено логирование изменений в разработке

## Следующие шаги
1. Добавить кэширование курсов валют
2. Реализовать систему уведомлений об изменении курсов
3. Улучшить административный интерфейс для ручной корректировки курсов
4. Внедрить систему логирования операций
5. Добавить документацию API
6. Настроить CI/CD
7. Разработать интерфейс для истории курсов валют
8. Добавить графики изменения курсов

## Известные проблемы
- Необходимо настроить CORS для продакшен окружения
- Требуется оптимизация загрузки изображений
- Нужно добавить обработку ошибок при недоступности API курсов

## История изменений

### 08.04.2025 (18:58)
- Исправлена логика расчета курсов валют на фронтенде
- Добавлена поддержка отображения всех валют в таблице и тикере
- Оптимизирована формула расчета курса покупки/продажи с учетом маржи 2.6%

### 08.04.2025 (16:00)
- Улучшен контроллер курсов валют в Strapi
- Настроено получение маржи из глобальных настроек
- Реализован правильный расчет курсов через EUR/USD
- Сохранение истории курсов в JSON файлах

### 08.04.2025 (начало)
- Запущен базовый фронтенд на порту 8000
- Настроен бэкенд на Strapi
- Реализован базовый функционал обмена валют
- Добавлена поддержка мультиязычности

## Заметки
- API ключ для курсов валют хранится в переменных окружения
- Обновление курсов происходит каждые 24 часа
- Поддерживаемые валюты: EUR, USD, CAD, NOK, SEK, DKK, GBP, CHF
- Курсы рассчитываются по формуле:
  - Курс покупки = базовый курс * (1 - маржа 2.6%)
  - Курс продажи = базовый курс * (1 + маржа 2.6%)
- Базовые курсы могут быть переопределены вручную через админку Strapi

# Руководство по разработке

## Архитектура проекта

### Frontend

Фронтенд построен на чистом JavaScript (ES6+) с использованием модульной архитектуры:

- `calculator.js` - Калькулятор валют
  - Поддерживает все основные валюты
  - Автоматический расчет кросс-курсов через EUR
  - Учет комиссии при конвертации
  - Валидация ввода
  - Форматирование сумм

- `exchange-rates.js` - Работа с курсами валют
  - Загрузка курсов из API
  - Кэширование в localStorage
  - Автоматическое обновление
  - Отображение в таблице

- `locale.js` - Система локализации
  - Поддержка EN, ES, RU
  - Динамическая загрузка переводов
  - Сохранение выбранного языка

- `theme.js` - Управление темой
  - Светлая/темная тема
  - Сохранение выбранной темы
  - Автоматическое определение системной темы

### Backend (Strapi)

Бэкенд реализован на Strapi CMS:

```
backend/
├── src/
│   ├── api/
│   │   └── rates/
│   │       ├── controllers/  # Логика API
│   │       ├── routes/       # Маршруты API
│   │       └── services/     # Бизнес-логика
│   └── config/
│       ├── database.js      # Настройки БД
│       └── server.js        # Настройки сервера
└── data/
    └── data.db             # SQLite база
```

#### API Endpoints

- `GET /api/rates` - Получение всех курсов
- `GET /api/rates/:id` - Получение курса по ID
- `POST /api/rates` - Создание нового курса
- `PUT /api/rates/:id` - Обновление курса
- `DELETE /api/rates/:id` - Удаление курса

Формат данных:
```json
{
  "currency": "USD",
  "buy": 1.05,
  "sell": 1.08,
  "updatedAt": "2024-04-09T10:00:00.000Z"
}
```

## Разработка

### Установка зависимостей

Frontend не требует установки зависимостей.

Backend (Strapi):
```bash
cd backend
npm install
```

### Запуск для разработки

1. Frontend:
```bash
python -m http.server 8000
```

2. Backend:
```bash
cd backend
npm run develop
```

### Сборка для продакшена

1. Frontend - минифицировать JS/CSS:
```bash
npm run build
```

2. Backend:
```bash
cd backend
NODE_ENV=production npm run build
```

## Деплой

### Подготовка

1. Настроить SSL:
```bash
certbot certonly --webroot
```

2. Создать конфиг Nginx/Apache
3. Настроить права доступа:
```bash
chown -R www-data:www-data /var/www/moneychange
chmod -R 755 /var/www/moneychange
```

### Запуск

1. Frontend - скопировать файлы:
```bash
rsync -av --delete dist/ /var/www/moneychange/
```

2. Backend:
```bash
cd backend
NODE_ENV=production npm start
```

## Git Workflow

1. Разработка ведется в ветках:
   - `main` - основная ветка
   - `feature/*` - новый функционал
   - `fix/*` - исправления
   
2. Перед мержем:
   - Проверить работу калькулятора
   - Проверить все языки
   - Проверить темы
   - Проверить API

## Исключения в .gitignore

```
# Backend
backend/.cache/
backend/.tmp/
backend/build/
backend/.env
backend/public/uploads/
backend/exports/
backend/.strapi-updater.json
backend/data/
backend/dist/

# Frontend
.DS_Store
node_modules/
dist/
*.log 